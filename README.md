# Mikrotik Cloudflare DNS Updater Script (RouterOS v7)
<br />

This script is for [Mikrotik](https://mikrotik.com/) RouterOS v7 routers *(last testing was done on v7.19.4)*.<br />
It updates Cloudflare DNS records whenever there’s a change in the router’s public IP address.

It’s important to note that Mikrotik RouterOS already includes an [IP Cloud DDNS](https://help.mikrotik.com/docs/spaces/ROS/pages/97779929/Cloud#Cloud-DDNS) feature.
This feature works great and can be used to recursively update other records (using CNAME) that point to the dynamic DNS record generated by Mikrotik.

However, I needed a script that could log changes to the WAN-IP and, optionally, also perform the Cloudflare DNS update.
<br /><br />

# Script Setup - Variables required in the RouterOS script

At the top of the script, there is a parameters definition Vector (`ParamVect`) where you can define
if you want to update a single Dns Record or multiple ones by populating one or more stanzas.

Each of them must have their own:
* `(First Line)` - The dns record *(Type A)* at Cloudflare you want to update (e.g. "mywanip1.domain.com").
* &nbsp;&nbsp;&nbsp;`DnsZoneID`&nbsp;&nbsp; - The Cloudflare DNS Zone ID. You can locate this in your Cloudflare dashboard.
* &nbsp;&nbsp;&nbsp;`DnsRcrdID`&nbsp;&nbsp; - The Cloudflare DNS Record ID. More details on this are provided below.
* &nbsp;&nbsp;&nbsp;`AuthToken`&nbsp;&nbsp; - The Cloudflare AuthKey/Token. You can create it in your Cloudflare dashboard.
<br /><br />
Notes:<br />
1. RouterOS script policies: read, write, test, and policy.<br />
2. Remember to add a Scheduler that starts the script every 5 minutes, or any interval that suits your needs.
<br />&nbsp;&nbsp;&nbsp;*(e.g. /system scheduler add interval=5m name=ddns-update on-event="/system script run ddns-update")*<br />
<br />

## Creating a Cloudflare API Auth/Key **Token** (`AuthToken`)

To create the Cloudflare AuthKey/Token (`AuthToken`) in the Cloudflare dashboard, follow these steps:

1. Click on the profile icon located at the top right corner of the dashboard, then select ‘My Profile’.
2. Navigate to ‘API Tokens’, and click on ‘Create Token’.
3. Select ‘Start with a template’, then choose the ‘Edit zone DNS’ template.
4. Under ‘Zone Resources’, select your top-level domain name.
5. Proceed by clicking ‘Continue to summary’.
6. Finally, click ‘Create Token’ to generate your API token.
<br /><br />

## Getting the Cloudflare DNS domain Zone ID (`DnsZoneID`)

You can locate this in your Cloudflare dashboard, select the domain "Overview" on the left and scroll down.
You'll find it on the right in the "API Zone ID" section.
<br /><br />

## Getting the Cloudflare DNS Record ID (`DnsRcrdID`) using a linux shell

1. **This process needs to be done only once to obtain the specific Record ID.**
2. This is for *Type A* DNS Record, if you need another type adjust the URL in the **curl** command (and in the RouterOS script as well).
3. The  " `| jq` "  at the end of the **curl** command is used to present the results in a more readable format. If you don’t have **jq** installed, you can simply remove the final pipe and parse the results manually.
4. Before launching the **curl** commands below, populate the initial variables and paste them into the shell too (or set values directly in the curl command).
5. In the field *"id"* (of *"result"*), you'll find the DNS Record ID you are looking for.

```
DnsRcName="mywanip1.domain.com"
DnsZoneID="Cloudflare_Dns_Zone_ID1"
AuthToken="Cloudflare_Auth_Key_Token1"


curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$DnsZoneID/dns_records?type=A&name=$DnsRcName" \
	-H "Authorization: Bearer $AuthToken" \
	-H "Content-Type: application/json" | jq
```
