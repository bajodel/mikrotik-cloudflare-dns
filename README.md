# Mikrotik Cloudflare DNS Updater Script (RouterOS v7)

This script is for [Mikrotik](https://mikrotik.com/) RouterOS v7 routers. It updates a Cloudflare DNS record whenever there’s a change in the router’s public IP address.

It’s important to note that Mikrotik RouterOS already includes an [IP Cloud DDNS](https://wiki.mikrotik.com/wiki/Manual:IP/Cloud#DDNS) feature.
This feature works efficiently and can be used to recursively update other records (using CNAME) that point to the dynamic DNS record generated by Mikrotik (for example "529c0491d41c.sn.mynetname.net").

However, I needed a script that could log all the changes to the WAN-IP and, optionally, perform the Cloudflare DNS update as well.
This script is the result of that requirement.


## General Notes for the Script:
1. The script requires the following policies: read, write, test, and policy.
2. After adding the script and populating the variables (details provided below), you need to add it to the Scheduler and set it for execution every 5 minutes, or any interval that suits your needs.

# Setup - Variables Required in the Script
  (Further details provided below)

* `CFAPIAUTHEMAIL` - The email associated with your Cloudflare account (required for API authentication).
* `CFAPIDNSRCNAME` - The dns record at CF you want to update (e.g. "mywanip.domain.com").
* `CFAPIDNSZONEID` - The Cloudflare DNS Zone ID. You can locate this in your Cloudflare dashboard.
* `CFAPIDNSRCRDID` - The Cloudflare DNS Record ID. More details on this are provided below.
* `CFAPIAUTHTOKEN` - The Cloudflare AuthKey/Token. You can create it in your Cloudflare dashboard.
<br /><br /><br />

## Creating a Cloudflare API Auth/Key **Token** (`CFAPIAUTHTOKEN`)

To create the Cloudflare AuthKey/Token (`CFAPIAUTHTOKEN`) in the Cloudflare dashboard, follow these steps:

1. Click on the profile icon located at the top right corner of the dashboard, then select ‘My Profile’.
2. Navigate to ‘API Tokens’, and click on ‘Create Token’.
3. Select ‘Start with a template’, then choose the ‘Edit zone DNS’ template.
4. Under ‘Zone Resources’, select your top-level domain name.
5. Proceed by clicking ‘Continue to summary’.
6. Finally, click ‘Create Token’ to generate your API token.
<br /><br />

## Getting the Cloudflare DNS domain Zone ID (`CFAPIDNSZONEID`)

You can locate this in your Cloudflare dashboard, select the domain "Overview" on the left and scroll down.
You'll find it on the right in the "API Zone ID" section.
<br /><br />

## Getting the Cloudflare DNS Record ID (`CFAPIDNSRCRDID`) using Linux/bash

Notes:
1. This process needs to be done only once to obtain the specific Record ID.
2. This is for *Type A* DNS Record, if you need another type adjust the URL in the **curl** command.
3. The `| jq` at the end of the **curl** command is used to present the results in a more readable format. If you don’t have **jq** installed, you can simply remove the final pipe and parse the results manually.
4. Before launching the **curl** commands below, populate the following variables (italic) and copy/paste them into bash too. Alternatively, you can manually substitute the variables directly in the curl command.
5. In the field *"id"* (of *"result"*), you'll find the DNS Record ID you are looking for.

### Getting the specific Type A DNS Record ID

CFAPIDNSRCNAME="*mywanip.domain.com*"<br />
CFAPIAUTHEMAIL="*mymail@mydomain.com*"<br />
CFAPIAUTHTOKEN="*___Cloudflare__Auth_Key_Token___*"<br />
CFAPIDNSZONEID="*_____Cloudflare_Dns_Zone_ID_____*"<br />

curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$CFAPIDNSZONEID/dns_records?type=A&name=$CFAPIDNSRCNAME" \
	-H "X-Auth-Email: $CFAPIAUTHEMAIL" \
	-H "Authorization: Bearer $CFAPIAUTHTOKEN" \
	-H "Content-Type: application/json" | jq

